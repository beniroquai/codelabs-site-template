<!doctype html>
<html lang="en" dir="ltr" class="docs-wrapper docs-doc-page docs-version-current plugin-docs plugin-id-default docs-doc-id-Electronics/CANBusIntegration">
<head>
<meta charset="UTF-8">
<meta name="generator" content="Docusaurus v2.2.0">
<title data-rh="true">CANBusIntegration | openUC2 Documentation</title><meta data-rh="true" name="viewport" content="width=device-width,initial-scale=1"><meta data-rh="true" name="twitter:card" content="summary_large_image"><meta data-rh="true" property="og:url" content="https://docs.youseetoo.org/docs/Electronics/CANBusIntegration"><meta data-rh="true" name="docusaurus_locale" content="en"><meta data-rh="true" name="docsearch:language" content="en"><meta data-rh="true" name="docusaurus_version" content="current"><meta data-rh="true" name="docusaurus_tag" content="docs-default-current"><meta data-rh="true" name="docsearch:version" content="current"><meta data-rh="true" name="docsearch:docusaurus_tag" content="docs-default-current"><meta data-rh="true" property="og:title" content="CANBusIntegration | openUC2 Documentation"><meta data-rh="true" name="description" content="Overview of the CAN Communication Implementation (ISO-TP) inside UC2-ESP32"><meta data-rh="true" property="og:description" content="Overview of the CAN Communication Implementation (ISO-TP) inside UC2-ESP32"><link data-rh="true" rel="icon" href="/img/favicon.ico"><link data-rh="true" rel="canonical" href="https://docs.youseetoo.org/docs/Electronics/CANBusIntegration"><link data-rh="true" rel="alternate" href="https://docs.youseetoo.org/docs/Electronics/CANBusIntegration" hreflang="en"><link data-rh="true" rel="alternate" href="https://docs.youseetoo.org/docs/Electronics/CANBusIntegration" hreflang="x-default"><link data-rh="true" rel="preconnect" href="https://DB3UCAMZ89-dsn.algolia.net" crossorigin="anonymous"><link rel="search" type="application/opensearchdescription+xml" title="openUC2 Documentation" href="/opensearch.xml">

        <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
        <script>var pdfData={};const getBaseUrl=function(n){return"/"},getDownloadItems=function(){for(var n,e=[],t=pdfData[(n=document.location.pathname,n.endsWith("/")?n.slice(0,-1):n)]||[],o=0,l=t.length;o<l;o++)"root"!==t[o].type?"section"!==t[o].type?"chapter"===t[o].type&&e.push({title:"Download page: <br/> <strong style=font-size:16px>"+t[o].label+"</strong>",path:"/"+t[o].file}):e.push({title:"Download section: <br/> <strong style=font-size:16px>"+t[o].label+"</strong>",path:"/"+t[o].file}):e.push({title:"Download complete version: <br/> <strong style=font-size:16px>"+t[o].label+"</strong>",path:"/"+t[o].file});return e},fillDownloadDropdownMenu=function(){$("#pdfDownloadMenuList").empty();const n=getDownloadItems();var e="";n.forEach((function(n){e+="<li>",e+='<a class="dropdown__link" href="'+n.path+'" download>'+n.title+"</a>",e+="</li>"})),0===e.length&&(e="<li>No PDF downloads on this page</li>"),$("#pdfDownloadMenuList").append(e)},fillDownloadSidebarMenu=function(){$("#pdfLinkSidebarMenu").empty();const n=getDownloadItems();var e="";n.forEach((function(n){e+='<li class="menu__list-item">',e+='<a class="menu__link" href="'+n.path+'" download>'+n.title+"</a>",e+="</li>"})),0===e.length&&(e="<li>No PDF downloads on this page</li>"),$("#pdfLinkSidebarMenu").append(e)},checkAndInsertPdfButtons=function(){if($("html").hasClass("plugin-docs")){if(!$("#pdfLink").length){var n=$('<div class="navbar__item dropdown dropdown--hoverable dropdown--right" id="pdfDownloadMenu">  <a class="navbar__item navbar__link pdfLink" id="pdfLink" href="#">Download as PDF</a>  <ul class="dropdown__menu" id="pdfDownloadMenuList"></ul></div>');$(".navbar__items--right").prepend(n),$("#pdfDownloadMenu").mouseenter(fillDownloadDropdownMenu)}if(!$("#pdfLinkSidebar").length){var e=$('<li class="menu__list-item menu__list-item--collapsed" id="pdfLinkSidebar"><a role="button" class="menu__link menu__link--sublist">Download as PDF</a><ul class="menu__list" id="pdfLinkSidebarMenu" style=""></ul></li>');$(".navbar-sidebar__items > .menu > .menu__list").append(e),$("#pdfLinkSidebar").click((function(){$("#pdfLinkSidebar").toggleClass("menu__list-item--collapsed")})),$(".navbar__toggle").click(fillDownloadSidebarMenu)}}};$(window).on("load",(function(){fetch("/pdfs.json").then((n=>n.json())).then((function(n){pdfData=n,checkAndInsertPdfButtons(),setInterval(checkAndInsertPdfButtons,1e3)}))}))</script>
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.13.24/dist/katex.min.css" integrity="sha384-odtC+0UGzzFL/6PNoE8rX/SPcQDXBJ+uRepguP4QkPCm2LBxH3FA3y+fKSiJ+AmM" crossorigin="anonymous"><link rel="stylesheet" href="/assets/css/styles.2142b3d2.css">
<link rel="preload" href="/assets/js/runtime~main.86319bb3.js" as="script">
<link rel="preload" href="/assets/js/main.cdf149a0.js" as="script">
</head>
<body class="navigation-with-keyboard">
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=function(){var t=null;try{t=localStorage.getItem("theme")}catch(t){}return t}();t(null!==e?e:"light")}()</script><div id="__docusaurus">
<div role="region" aria-label="Skip to main content"><a class="skipToContent_fXgn" href="#docusaurus_skipToContent_fallback">Skip to main content</a></div><nav class="navbar navbar--fixed-top"><div class="navbar__inner"><div class="navbar__items"><button aria-label="Toggle navigation bar" aria-expanded="false" class="navbar__toggle clean-btn" type="button"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" href="/"><div class="navbar__logo"><img src="/img/Artboard4@4x.png" alt="openUC2 Logo" class="themedImage_ToTc themedImage--light_HNdA"><img src="/img/Artboard4@4x.png" alt="openUC2 Logo" class="themedImage_ToTc themedImage--dark_i4oU"></div><b class="navbar__title text--truncate">openUC2 Documentation</b></a><a aria-current="page" class="navbar__item navbar__link navbar__link--active" href="/docs/intro">Tutorial</a></div><div class="navbar__items navbar__items--right"><a href="https://github.com/openuc2/" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link">GitHub<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a><div class="toggle_vylO colorModeToggle_DEke"><button class="clean-btn toggleButton_gllP toggleButtonDisabled_aARS" type="button" disabled="" title="Switch between dark and light mode (currently light mode)" aria-label="Switch between dark and light mode (currently light mode)" aria-live="polite"><svg viewBox="0 0 24 24" width="24" height="24" class="lightToggleIcon_pyhR"><path fill="currentColor" d="M12,9c1.65,0,3,1.35,3,3s-1.35,3-3,3s-3-1.35-3-3S10.35,9,12,9 M12,7c-2.76,0-5,2.24-5,5s2.24,5,5,5s5-2.24,5-5 S14.76,7,12,7L12,7z M2,13l2,0c0.55,0,1-0.45,1-1s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S1.45,13,2,13z M20,13l2,0c0.55,0,1-0.45,1-1 s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S19.45,13,20,13z M11,2v2c0,0.55,0.45,1,1,1s1-0.45,1-1V2c0-0.55-0.45-1-1-1S11,1.45,11,2z M11,20v2c0,0.55,0.45,1,1,1s1-0.45,1-1v-2c0-0.55-0.45-1-1-1C11.45,19,11,19.45,11,20z M5.99,4.58c-0.39-0.39-1.03-0.39-1.41,0 c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0s0.39-1.03,0-1.41L5.99,4.58z M18.36,16.95 c-0.39-0.39-1.03-0.39-1.41,0c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0c0.39-0.39,0.39-1.03,0-1.41 L18.36,16.95z M19.42,5.99c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06c-0.39,0.39-0.39,1.03,0,1.41 s1.03,0.39,1.41,0L19.42,5.99z M7.05,18.36c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06 c-0.39,0.39-0.39,1.03,0,1.41s1.03,0.39,1.41,0L7.05,18.36z"></path></svg><svg viewBox="0 0 24 24" width="24" height="24" class="darkToggleIcon_wfgR"><path fill="currentColor" d="M9.37,5.51C9.19,6.15,9.1,6.82,9.1,7.5c0,4.08,3.32,7.4,7.4,7.4c0.68,0,1.35-0.09,1.99-0.27C17.45,17.19,14.93,19,12,19 c-3.86,0-7-3.14-7-7C5,9.07,6.81,6.55,9.37,5.51z M12,3c-4.97,0-9,4.03-9,9s4.03,9,9,9s9-4.03,9-9c0-0.46-0.04-0.92-0.1-1.36 c-0.98,1.37-2.58,2.26-4.4,2.26c-2.98,0-5.4-2.42-5.4-5.4c0-1.81,0.89-3.42,2.26-4.4C12.92,3.04,12.46,3,12,3L12,3z"></path></svg></button></div><div class="searchBox_ZlJk"><button type="button" class="DocSearch DocSearch-Button" aria-label="Search"><span class="DocSearch-Button-Container"><svg width="20" height="20" class="DocSearch-Search-Icon" viewBox="0 0 20 20"><path d="M14.386 14.386l4.0877 4.0877-4.0877-4.0877c-2.9418 2.9419-7.7115 2.9419-10.6533 0-2.9419-2.9418-2.9419-7.7115 0-10.6533 2.9418-2.9419 7.7115-2.9419 10.6533 0 2.9419 2.9418 2.9419 7.7115 0 10.6533z" stroke="currentColor" fill="none" fill-rule="evenodd" stroke-linecap="round" stroke-linejoin="round"></path></svg><span class="DocSearch-Button-Placeholder">Search</span></span><span class="DocSearch-Button-Keys"></span></button></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div id="docusaurus_skipToContent_fallback" class="main-wrapper mainWrapper_z2l0 docsWrapper_BCFX"><button aria-label="Scroll back to top" class="clean-btn theme-back-to-top-button backToTopButton_sjWU" type="button"></button><div class="docPage__5DB"><aside class="theme-doc-sidebar-container docSidebarContainer_b6E3"><div class="sidebar_njMd"><nav class="menu thin-scrollbar menu_SIkG"><ul class="theme-doc-sidebar-menu menu__list"><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" aria-expanded="false" href="/docs/General/ModuleDeveloperKit/">General</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" aria-expanded="false" href="/docs/Toolboxes/">Educational Kits</a><button aria-label="Toggle the collapsible sidebar category &#x27;Educational Kits&#x27;" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" aria-expanded="false" href="/docs/Investigator/ZMicroscope/UpackZMicroscope">Investigator</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret menu__link--active" aria-expanded="true" href="/docs/Electronics/uc2e1">Electronics</a></div><ul style="display:block;overflow:visible;height:auto" class="menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/Electronics/uc2e1">Introduction</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/Electronics/uc2e2v2">UC2 Standalone Board V2</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/Electronics/uc2e2v3">UC2 Standalone Board V3</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/Electronics/uc2e3">Getting Started</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/Electronics/uc2e5">REST principle</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/Electronics/uc2e5.1">REST commands</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/Electronics/uc2e6">Connecting devices</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/Electronics/uc2e7">Controlling the UC2e</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/Electronics/Controlling_the_ESP32_APP">UC2Serial Android App</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/Electronics/uc2e8">Compiling from Scratch</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/Electronics/uc2e9">Replace Hardware</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/Electronics/PS4-Controller">PS4-Controller</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/Electronics/StepperMotorBackpack">Documentation for Stepper Motor Controller with Rotational Encoder (TMC2209 + AS5600)</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/Electronics/RaspberryPiHat+">HAT+</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link menu__link--active" aria-current="page" tabindex="0" href="/docs/Electronics/CANBusIntegration">CANBusIntegration</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/Electronics/uc2e5.2">Python commands</a></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" aria-expanded="false" tabindex="0" href="/docs/Electronics/UC2-ESP/Setup_Buildenvironment">UC2-ESP</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" aria-expanded="false" tabindex="0" href="/docs/Electronics/UC2-REST/INTRO">UC2-REST</a></div></li></ul></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" aria-expanded="false" href="/docs/ImSwitch/DahengCamera">ImSwitch</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" aria-expanded="false" href="/docs/WORKSHOPS/">openUC2 Workshops</a><button aria-label="Toggle the collapsible sidebar category &#x27;openUC2 Workshops&#x27;" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" aria-expanded="false" href="/docs/PRODUCTION/INVESTIGATOR/ProductionXYZMicroscope">PRODUCTION</a></div></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/docs/intro">openUC2 Documentation</a></li></ul></nav></div></aside><main class="docMainContainer_gTbr"><div class="container padding-top--md padding-bottom--lg"><div class="row"><div class="col docItemCol_VOVn"><div class="docItemContainer_Djhp"><article><nav class="theme-doc-breadcrumbs breadcrumbsContainer_Z_bl" aria-label="Breadcrumbs"><ul class="breadcrumbs" itemscope="" itemtype="https://schema.org/BreadcrumbList"><li class="breadcrumbs__item"><a aria-label="Home page" class="breadcrumbs__link" href="/"><svg viewBox="0 0 24 24" class="breadcrumbHomeIcon_OVgt"><path d="M10 19v-5h4v5c0 .55.45 1 1 1h3c.55 0 1-.45 1-1v-7h1.7c.46 0 .68-.57.33-.87L12.67 3.6c-.38-.34-.96-.34-1.34 0l-8.36 7.53c-.34.3-.13.87.33.87H5v7c0 .55.45 1 1 1h3c.55 0 1-.45 1-1z" fill="currentColor"></path></svg></a></li><li class="breadcrumbs__item"><span class="breadcrumbs__link">Electronics</span><meta itemprop="position" content="1"></li><li itemscope="" itemprop="itemListElement" itemtype="https://schema.org/ListItem" class="breadcrumbs__item breadcrumbs__item--active"><span class="breadcrumbs__link" itemprop="name">CANBusIntegration</span><meta itemprop="position" content="2"></li></ul></nav><div class="tocCollapsible_ETCw theme-doc-toc-mobile tocMobile_ITEo"><button type="button" class="clean-btn tocCollapsibleButton_TO0P">On this page</button></div><div class="theme-doc-markdown markdown"><header><h1>CANBusIntegration</h1></header><p><strong>Overview of the CAN Communication Implementation (ISO-TP) inside UC2-ESP32</strong></p><p>This library provides an ISO-TP–based CAN interface for communication among various modules (motors, lasers, etc.) connected to the ESP32. At startup, the ESP32 brings all nodes to a known state (e.g., stopping motors), then collects status information (such as motor positions) via CAN. Though CAN itself lacks a strict “master/slave” concept, the ESP32 acts as a central controller by sending commands and processing status updates from any node. Whenever external input arrives (e.g., from a joystick), the library converts these commands into CAN messages that control motor speed or other device behavior.</p><p>The platformio firmware for the esp32 is here:
<a href="https://github.com/youseetoo/uc2-esp32/tree/betaBD/main/src" target="_blank" rel="noopener noreferrer">https://github.com/youseetoo/uc2-esp32/tree/betaBD/main/src</a></p><p>Relevant files are in the folder
<a href="https://github.com/youseetoo/uc2-esp32/tree/betaBD/main/src/can" target="_blank" rel="noopener noreferrer">https://github.com/youseetoo/uc2-esp32/tree/betaBD/main/src/can</a>
and
<a href="https://github.com/youseetoo/uc2-esp32/tree/betaBD/main/src/motor" target="_blank" rel="noopener noreferrer">https://github.com/youseetoo/uc2-esp32/tree/betaBD/main/src/motor</a>
<a href="https://github.com/youseetoo/uc2-esp32/tree/betaBD/main/src/laser" target="_blank" rel="noopener noreferrer">https://github.com/youseetoo/uc2-esp32/tree/betaBD/main/src/laser</a></p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="general-behaviour">General Behaviour<a class="hash-link" href="#general-behaviour" title="Direct link to heading">​</a></h2><p>When the ESP32 firmware boots, it immediately sends a stop command to each connected device (e.g., motors). Each motor halts and reports its current position back over the CAN bus, and this position is stored on the ESP32 for synchronization. Although CAN itself does not inherently define master or slave nodes, the ESP32 takes on a supervisory role by gathering updates from all auxiliary components and sending commands to them as needed. If a device, such as a joystick, triggers an update, the ESP32 recognizes it and reacts accordingly—for instance, a PS4 controller connected via Bluetooth can signal the ESP32 to command the motors to move at a speed proportional to the joystick’s position.</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="detailed-information">Detailed information<a class="hash-link" href="#detailed-information" title="Direct link to heading">​</a></h2><h3 class="anchor anchorWithStickyNavbar_LWe7" id="1-file-structure-and-responsibilities"><strong>1. File Structure and Responsibilities</strong><a class="hash-link" href="#1-file-structure-and-responsibilities" title="Direct link to heading">​</a></h3><ul><li><code>can_config.h</code><ul><li>Contains configuration constants and parameters for the CAN/TWAI interface (e.g., baud rates, pins, RX/TX queue sizes).</li></ul></li><li><code>can_bus.h</code> / <code>can_bus.cpp</code><ul><li>Handles low-level CAN/TWAI driver initialization on the ESP32.</li><li>Sets up the driver, assigns GPIO pins for RX/TX, configures filters, and starts the driver tasks.</li></ul></li><li><code>can_communication.h</code> / <code>can_communication.cpp</code><ul><li>Implements the ISO-TP protocol layer on top of the raw CAN driver.</li><li>Provides functions to send/receive multi-frame messages.</li><li>Performs segmentation/reassembly of data larger than 8 bytes.</li><li>Dispatches received ISO-TP messages to the appropriate handling functions in other modules (e.g., motor, laser).</li></ul></li><li><code>motor_control.h</code> / <code>motor_control.cpp</code><ul><li>Defines commands and data structures for motor control.</li><li>Uses the CAN/ISO-TP interface to send motor commands and receive status/responses.</li></ul></li><li><code>laser_control.h</code> / <code>laser_control.cpp</code><ul><li>Defines commands and data structures for laser control.</li><li>Uses the same CAN/ISO-TP interface to transmit commands (e.g., turn laser on/off, adjust power) and handle responses.</li></ul></li></ul><h3 class="anchor anchorWithStickyNavbar_LWe7" id="2-driver-initialization-can_buscpp"><strong>2. Driver Initialization (can_bus.cpp)</strong><a class="hash-link" href="#2-driver-initialization-can_buscpp" title="Direct link to heading">​</a></h3><ul><li>A function (e.g., <code>canBusInit()</code>) initializes the ESP32 TWAI driver with parameters (baud rate, pins, mode).</li><li>A TX queue and RX queue are created so that incoming CAN frames are posted to an internal task for processing.</li><li>The driver is started, placing the interface in active mode to send and receive frames.</li></ul><h3 class="anchor anchorWithStickyNavbar_LWe7" id="3-iso-tp-layer-can_communicationcpp"><strong>3. ISO-TP Layer (can_communication.cpp)</strong><a class="hash-link" href="#3-iso-tp-layer-can_communicationcpp" title="Direct link to heading">​</a></h3><ul><li>Implements a standard ISO-TP segmentation and reassembly approach:<ul><li><strong>Single Frame (SF)</strong> for messages ≤ 7 bytes.</li><li><strong>First Frame (FF)</strong> + <strong>Consecutive Frames (CF)</strong> for messages &gt; 7 bytes.</li><li><strong>Flow Control (FC)</strong> frames to manage multi-frame flow and pacing.</li></ul></li><li>Data is wrapped in ISO-TP PDUs: the first nibble of the first byte indicates the frame type, and subsequent bytes indicate total payload length (for FF) or the consecutive frame index (for CF).</li><li><code>sendISOTPMessage()</code> (naming may vary) takes a destination CAN ID, a pointer to the payload, and its length. It:<ul><li>Splits the data into single or multi-frame segments.</li><li>Sends each segment with the correct ISO-TP header.</li></ul></li><li><code>onCanFrameReceived()</code> (or similar) is invoked when the low-level driver passes a new frame:<ul><li>Checks if it’s a single frame or part of a multi-frame sequence.</li><li>Collects and reassembles data in a buffer if needed.</li><li>Once a complete message is reassembled, dispatches it to a higher-level handler via a function such as <code>processIsotpMessage(can_id, data, length)</code>.</li></ul></li></ul><h3 class="anchor anchorWithStickyNavbar_LWe7" id="4-message-routing-and-handling"><strong>4. Message Routing and Handling</strong><a class="hash-link" href="#4-message-routing-and-handling" title="Direct link to heading">​</a></h3><ul><li><strong>Master → Motor</strong>:<ul><li>Commands (e.g., set motor speed, move, stop, home) are packaged in a data buffer.</li><li><code>motor_control.cpp</code> calls a function in <code>can_communication.cpp</code> to send the command using the motor’s assigned CAN ID.</li><li>The motor firmware or slave node replies with a status or acknowledgment frame.</li><li>A callback in <code>motor_control.cpp</code> interprets these replies (position reached, error states, etc.).</li></ul></li><li><strong>Master → Laser</strong>:<ul><li>Commands to enable/disable the laser, set power level, or check status are prepared similarly.</li><li><code>laser_control.cpp</code> calls the ISO-TP send function with the laser’s assigned CAN ID.</li><li>Replies from the laser node are received and passed back to <code>laser_control.cpp</code> for handling (e.g., reading actual power, temperature, error codes).</li></ul></li></ul><h3 class="anchor anchorWithStickyNavbar_LWe7" id="5-typical-flow"><strong>5. Typical Flow</strong><a class="hash-link" href="#5-typical-flow" title="Direct link to heading">​</a></h3><ol><li><strong>Initialization</strong><ul><li><code>canBusInit()</code> starts the low-level driver.</li><li><code>initCanCommunication()</code> (if present) sets up internal buffers/tables for ISO-TP.</li></ul></li><li><strong>Sending a Command</strong><ul><li>The motor or laser module constructs a payload (command + parameters).</li><li>Calls <code>sendISOTPMessage(motor_can_id, payload, length)</code> or <code>sendISOTPMessage(laser_can_id, payload, length)</code>.</li><li>The ISO-TP layer segments the data if necessary and transmits.</li></ul></li><li><strong>Receiving a Response</strong><ul><li>The low-level driver receives each CAN frame in the RX queue.</li><li><code>onCanFrameReceived()</code> reassembles multi-frame messages (if needed).</li><li>Once reassembly completes, <code>processIsotpMessage()</code> routes the final data to the correct higher-level function: <code>handleMotorMessage()</code> or <code>handleLaserMessage()</code>.</li><li>The motor/laser modules parse the data and update internal state or trigger further actions.</li></ul></li></ol><h3 class="anchor anchorWithStickyNavbar_LWe7" id="6-configuration-parameters-can_configh"><strong>6. Configuration Parameters (can_config.h)</strong><a class="hash-link" href="#6-configuration-parameters-can_configh" title="Direct link to heading">​</a></h3><ul><li>Definitions for baud rate (e.g., 250 kbit/s or 500 kbit/s).</li><li>Pins for TX and RX (commonly GPIO4 for RX and GPIO5 for TX on ESP32, but can vary).</li><li>ISO-TP protocol constants like timeouts, flow control behavior, and max buffer size.</li></ul><h3 class="anchor anchorWithStickyNavbar_LWe7" id="7-masterslave-can-ids"><strong>7. Master/Slave CAN IDs</strong><a class="hash-link" href="#7-masterslave-can-ids" title="Direct link to heading">​</a></h3><ul><li>The firmware typically assigns unique CAN IDs to each slave (motor, laser, etc.).</li><li>The master uses another ID or set of IDs for transmission and expects responses from the matching IDs.</li><li>The exact numeric IDs can be found in <code>can_config.h</code> or within the motor/laser modules.</li></ul><h3 class="anchor anchorWithStickyNavbar_LWe7" id="8-extending-commands"><strong>8. Extending Commands</strong><a class="hash-link" href="#8-extending-commands" title="Direct link to heading">​</a></h3><ul><li>New commands can be defined by expanding the enumerations or definitions in <code>motor_control.h</code> or <code>laser_control.h</code>.</li><li>Corresponding parsing logic (in the receive callback for each device) must handle the new command codes.</li></ul><h3 class="anchor anchorWithStickyNavbar_LWe7" id="9-error-handling"><strong>9. Error Handling</strong><a class="hash-link" href="#9-error-handling" title="Direct link to heading">​</a></h3><ul><li>The ISO-TP layer checks for missing frames and timeouts.</li><li>If frames are not received in a defined timeout window, the reassembly is aborted.</li><li>Callbacks or error codes can be sent back to the motor or laser modules to indicate incomplete transfers or bus errors.</li></ul><h3 class="anchor anchorWithStickyNavbar_LWe7" id="10-summary-of-key-points"><strong>10. Summary of Key Points</strong><a class="hash-link" href="#10-summary-of-key-points" title="Direct link to heading">​</a></h3><ul><li><code>can_bus.*</code> sets up and runs the low-level CAN/TWAI driver.</li><li><code>can_communication.*</code> manages ISO-TP (splitting/joining multi-frame data).</li><li><code>motor_control.*</code> and <code>laser_control.*</code> define higher-level commands sent over ISO-TP.</li><li>Incoming frames are routed to the relevant device module once reassembled.</li></ul><p>All higher-level device control (motor and laser) flows through the ISO-TP layer provided in <code>can_communication.cpp</code>, ensuring that large payloads or complex commands are split and reassembled according to the ISO-TP standard.</p></div></article><nav class="pagination-nav docusaurus-mt-lg" aria-label="Docs pages navigation"><a class="pagination-nav__link pagination-nav__link--prev" href="/docs/Electronics/RaspberryPiHat+"><div class="pagination-nav__sublabel">Previous</div><div class="pagination-nav__label">HAT+</div></a><a class="pagination-nav__link pagination-nav__link--next" href="/docs/Electronics/uc2e5.2"><div class="pagination-nav__sublabel">Next</div><div class="pagination-nav__label">Python commands</div></a></nav></div></div><div class="col col--3"><div class="tableOfContents_bqdL thin-scrollbar theme-doc-toc-desktop"><ul class="table-of-contents table-of-contents__left-border"><li><a href="#general-behaviour" class="table-of-contents__link toc-highlight">General Behaviour</a></li><li><a href="#detailed-information" class="table-of-contents__link toc-highlight">Detailed information</a><ul><li><a href="#1-file-structure-and-responsibilities" class="table-of-contents__link toc-highlight"><strong>1. File Structure and Responsibilities</strong></a></li><li><a href="#2-driver-initialization-can_buscpp" class="table-of-contents__link toc-highlight"><strong>2. Driver Initialization (can_bus.cpp)</strong></a></li><li><a href="#3-iso-tp-layer-can_communicationcpp" class="table-of-contents__link toc-highlight"><strong>3. ISO-TP Layer (can_communication.cpp)</strong></a></li><li><a href="#4-message-routing-and-handling" class="table-of-contents__link toc-highlight"><strong>4. Message Routing and Handling</strong></a></li><li><a href="#5-typical-flow" class="table-of-contents__link toc-highlight"><strong>5. Typical Flow</strong></a></li><li><a href="#6-configuration-parameters-can_configh" class="table-of-contents__link toc-highlight"><strong>6. Configuration Parameters (can_config.h)</strong></a></li><li><a href="#7-masterslave-can-ids" class="table-of-contents__link toc-highlight"><strong>7. Master/Slave CAN IDs</strong></a></li><li><a href="#8-extending-commands" class="table-of-contents__link toc-highlight"><strong>8. Extending Commands</strong></a></li><li><a href="#9-error-handling" class="table-of-contents__link toc-highlight"><strong>9. Error Handling</strong></a></li><li><a href="#10-summary-of-key-points" class="table-of-contents__link toc-highlight"><strong>10. Summary of Key Points</strong></a></li></ul></li></ul></div></div></div></div></main></div></div><footer class="footer footer--dark"><div class="container container-fluid"><div class="row footer__links"><div class="col footer__col"><div class="footer__title">Docs</div><ul class="footer__items clean-list"><li class="footer__item"><a class="footer__link-item" href="/docs/intro">Tutorial</a></li></ul></div><div class="col footer__col"><div class="footer__title">Community</div><ul class="footer__items clean-list"><li class="footer__item"><a href="https://youseetoo.org" target="_blank" rel="noopener noreferrer" class="footer__link-item">Discourse<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li class="footer__item"><a href="https://twitter.com/OpenUc2" target="_blank" rel="noopener noreferrer" class="footer__link-item">Twitter<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li></ul></div><div class="col footer__col"><div class="footer__title">More</div><ul class="footer__items clean-list"><li class="footer__item"><a class="footer__link-item" href="/blog">Blog</a></li><li class="footer__item"><a href="https://github.com/openuc2/" target="_blank" rel="noopener noreferrer" class="footer__link-item">GitHub<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li></ul></div></div><div class="footer__bottom text--center"><div class="footer__copyright">Copyright © 2025 openUC2.</div></div></div></footer></div>
<script src="/assets/js/runtime~main.86319bb3.js"></script>
<script src="/assets/js/main.cdf149a0.js"></script>
</body>
</html>